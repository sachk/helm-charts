# Supabase on Kubernetes (paper.observer) — Minimal Deploy Guide

This stack is wired for:

- Domains: api.paper.observer (API), studio.paper.observer (Studio), paper.observer (Site URL)
- Istio routing (VirtualServices). Kong ingress is disabled.
- SMTP: Purelymail (smtp.purelymail.com:465, SSL/TLS)

You must provide:

- JWT: anonKey, serviceKey, secret
- SMTP credentials

Everything else (DB/dashboard/analytics/pooler keys) is auto-generated by Helm.

---

## 1) Generate JWT and create Secret (minimal)

```bash
# From charts/supabase/
NAMESPACE=supabase SECRET_NAME=supabase-jwt ENV_FILE=.env ./generate-jwt.sh
```

What this does:

- Writes `.env` with SUPABASE_JWT_SECRET, SUPABASE_ANON_KEY, SUPABASE_SERVICE_KEY
- Creates/updates Kubernetes Secret `${SECRET_NAME}` in `${NAMESPACE}`

(Optional) You can also paste these into values.yaml instead of creating a Secret.

---

## 2) Create SMTP Secret (Purelymail)

```bash
kubectl create namespace supabase

kubectl -n supabase create secret generic supabase-smtp \
  --from-literal=username="your-email@paper.observer" \
  --from-literal=password="your-purelymail-password"
```

---

## 3) Minimal values.yaml wiring

- Domains and Istio are already set:
  - api.paper.observer → Kong
  - studio.paper.observer → Studio
  - istio.gateway: gateways/primary
- Kong ingress is disabled (Istio VirtualServices take over).
- SMTP env is set to Purelymail (host/port).

Just point secrets to the two you created:

```yaml
secret:
  jwt:
    # Use the Secret created by generate-jwt.sh
    secretRef: "supabase-jwt"
    secretRefKey:
      anonKey: anonKey
      serviceKey: serviceKey
      secret: secret

  smtp:
    # Use your Purelymail Secret
    secretRef: "supabase-smtp"
    secretRefKey:
      username: username
      password: password
# Leave other secretRefs empty to let Helm auto-generate:
# secret.db/secret.dashboard/secret.analytics/secret.pooler
```

Helm will auto-generate all other secrets securely if their `secretRef` is empty.

---

## 4) Install / Upgrade

```bash
helm install supabase . -n supabase --create-namespace
# or
helm upgrade supabase . -n supabase
```

---

## 5) Verify

```bash
kubectl get pods -n supabase
kubectl get svc -n supabase
kubectl get virtualservice -n supabase
```

---

## 6) URLs

- API: https://api.paper.observer
- Studio: https://studio.paper.observer

---

## Notes

- Required to provide: JWT (anonKey, serviceKey, secret) and SMTP credentials.
- Auto-generated by Helm (when not provided): DB, dashboard, analytics, pooler (and S3 if enabled).
- Disabled by default: realtime, functions, vector, minio (enable only if needed).
